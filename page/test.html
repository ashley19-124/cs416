<!DOCTYPE html>
<html>
<head>
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src="https://unpkg.com/d3-svg-annotation@2.5.1/d3-annotation.min.js"></script>
  <style>
    body {
      font-family: Arial, Helvetica, sans-serif;
    }
    .center {
      text-align: center;
    }
    .button {
      border: none;
      color: white;
      padding: 8px 16px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 12px;
      margin: auto;
      transition-duration: 0.4s;
    }
    .button:disabled {
      opacity: 0;
    }
    .button1 {
      background-color: white; 
      color: black; 
      border: 2px solid steelblue;
      opacity: 1;
    }
    .button1:hover:not(:disabled) {
      background-color: steelblue;
      opacity: 0.5;
      color: white;
    }
  </style>
  <title>Main Page</title>
</head>

<body onload="init()">
  <h1 style="text-align: center;">Microsoft (MSFT) Stock Price History</h1>
  <p style="text-align: center;"><i>2007 to 2020: Windows 7 to Outlook.com and Microsoft Edge</i></p>
  <div class="center">
    <a href="https://ashley19-124.github.io/cs416/page/second.html" class="button button1">Back</a>
    <a href="https://ashley19-124.github.io/cs416/page/fourth.html" class="button button1">Next</a>
  </div>

  <div id="tooltip" style="
    position: absolute;
    opacity: 0;
    background: white;
    border: 1px solid gray;
    padding: 8px;
    font-size: 12px;
    pointer-events: none;
    border-radius: 4px;
    z-index: 10;
  "></div>

  <div id="chart" style="text-align: center; margin-top: 20px;"></div>

  <script>
    function init() {
      d3.csv("https://raw.githubusercontent.com/ashley19-124/cs416/refs/heads/main/images/MSFT%202007%20to%202020.csv", function(d) {
        return {
          date: new Date(d.Date),
          close: +d.Close,
          high: +d.High,
          low: +d.Low,
          open: +d.Open,
          volume: +d.Volume
        };
      }, function(error, data) {
        if (error) throw error;

        var width = 928, height = 500;
        var marginTop = 20, marginRight = 30, marginBottom = 30, marginLeft = 40;

        var x = d3.scaleTime()
          .domain(d3.extent(data, function(d) { return d.date; }))
          .range([marginLeft, width - marginRight]);

        var y = d3.scaleLinear()
          .domain([0, d3.max(data, function(d) { return d.close; })])
          .range([height - marginBottom, marginTop]);

        var line = d3.line()
          .x(function(d) { return x(d.date); })
          .y(function(d) { return y(d.close); });

        var svg = d3.select("#chart").append("svg")
          .attr("width", width)
          .attr("height", height);

        var tooltip = d3.select("#tooltip");

        svg.append("g")
          .attr("transform", "translate(0," + (height - marginBottom) + ")")
          .call(d3.axisBottom(x).ticks(width / 80).tickSizeOuter(0));

        svg.append("g")
          .attr("transform", "translate(" + marginLeft + ",0)")
          .call(d3.axisLeft(y).ticks(height / 40))
          .call(function(g) {
            g.select(".domain").remove();
            g.selectAll(".tick line").clone()
              .attr("x2", width - marginLeft - marginRight)
              .attr("stroke-opacity", 0.1);
            g.append("text")
              .attr("x", -marginLeft)
              .attr("y", 10)
              .attr("fill", "currentColor")
              .attr("text-anchor", "start")
              .text("â†‘ Daily close ($)");
          });

        svg.append("path")
          .datum(data)
          .attr("fill", "none")
          .attr("stroke", "steelblue")
          .attr("stroke-width", 2)
          .attr("d", line);

        svg.append("g")
          .selectAll("rect")
          .data(data)
          .enter()
          .append("rect")
          .attr("x", function(d) { return x(d.date) - 5; })
          .attr("width", 10)
          .attr("y", marginTop)
          .attr("height", height - marginTop - marginBottom)
          .attr("fill", "transparent")
          .attr("pointer-events", "all")
          .on("mouseover", function(d) {
            tooltip
              .style("opacity", 1)
              .html("<strong>Date:</strong> " + d.date.toLocaleDateString() + "<br>" +
                    "<strong>Close:</strong> $" + d.close.toFixed(2) + "<br>" +
                    "<strong>High:</strong> $" + d.high.toFixed(2) + "<br>" +
                    "<strong>Low:</strong> $" + d.low.toFixed(2) + "<br>" +
                    "<strong>Open:</strong> $" + d.open.toFixed(2) + "<br>" +
                    "<strong>Volume:</strong> " + d.volume)
              .style("left", (d3.event.pageX + 10) + "px")
              .style("top", (d3.event.pageY - 28) + "px");
          })
          .on("mouseout", function() {
            tooltip.style("opacity", 0);
          });

        // Optional: annotations (example for one point)
        var keyDate = new Date("2012-10-26");
        var point = data.find(d => d.date.getTime() === keyDate.getTime());

        if (point) {
          var annotations = [
            {
              note: {
                title: "Windows 8 Launch",
                label: "Closing Price: $" + point.close.toFixed(2)
              },
              x: x(point.date),
              y: y(point.close),
              dx: 30,
              dy: -40
            }
          ];

          var makeAnnotations = d3.annotation()
            .type(d3.annotationLabel)
            .annotations(annotations);

          svg.append("g")
            .attr("class", "annotation-group")
            .call(makeAnnotations);
        }
      });
    // Append SVG
    const svg = d3.select("body")
      .append("svg")
      .attr("width", width)
      .attr("height", height);
    
    
    // Line generator
    const line = d3.line()
      .x(d => x(d.date))
      .y(d => y(d.close));
    
    // Add the path
    svg.append("path")
      .datum(data)
      .attr("fill", "none")
      .attr("stroke", "steelblue")
      .attr("stroke-width", 1.5)
      .attr("d", line);
    
    // === Hover Line === //
    const hoverLine = svg.append("line")
      .attr("stroke", "black")
      .attr("stroke-width", 1)
      .attr("y1", marginTop)
      .attr("y2", height - marginBottom)
      .style("opacity", 0);
    
    // Tooltip group
    const tooltip = svg.append("g")
      .style("display", "none");
    
    tooltip.append("circle")
      .attr("r", 4)
      .attr("fill", "red");
    
    const tooltipText = tooltip.append("text")
      .attr("x", 9)
      .attr("dy", "-0.4em")
      .style("font-size", "10px");
    
    // Overlay for capturing mouse
    svg.append("rect")
      .attr("fill", "none")
      .attr("pointer-events", "all")
      .attr("width", width)
      .attr("height", height)
      .on("mouseover", () => {
        hoverLine.style("opacity", 1);
        tooltip.style("display", null);
      })
      .on("mouseout", () => {
        hoverLine.style("opacity", 0);
        tooltip.style("display", "none");
      })
      .on("mousemove", function (event) {
        const [mx] = d3.pointer(event);
        const bisectDate = d3.bisector(d => d.date).left;
        const date = x.invert(mx);
        const index = bisectDate(data, date, 1);
        const a = data[index - 1];
        const b = data[index];
        const d = date - a.date > b.date - date ? b : a;
    
        hoverLine.attr("x1", x(d.date)).attr("x2", x(d.date));
        tooltip.attr("transform", `translate(${x(d.date)},${y(d.close)})`);
        tooltipText.text(`$${d.close.toFixed(2)}`);
      });

    }
  </script>
</body>
</html>
